
{% extends "base.html" %}

{% block content %}
{% load static %}
<div class="content">
    <div class="main">
        <div class="chart">
            <div class="graph-chart">
                <!-- Top Bar with Search and Timer -->
                <div class="top-bar">
                    <!-- Search 1 Section (Left) -->
                    <div class="search1">
                        <div class="serch-main" onclick="openPopup()">
                            <p class="p-icon"><i class="fa-solid fa-magnifying-glass"></i></p>
                            <span>{{portfolio.symbol}}</span>
                        </div>
                        <div class="serch-dropdown" id="search1-dropdown">
                            <input type="text" placeholder="Search...">
                            <button onclick="searchFunction()">Search</button>
                        </div>
                    </div>
        
                    <!-- Timer Section (Middle) -->
                    <div class="timer">
                        <span class="hour"></span>
                        <span class="min"></span>
                        <span class="sec"></span>
        
                        <button class="dropdown-btn" onclick="toggleTimerDropdown(event)">
                            {{interval_data}} <i class="fa fa-caret-down"></i>
                        </button>
                        <div class="timer-dropdown" id="timer-dropdown" >
                           
                            <option value="1d">1 day</option>
                            <option value="5d">5 day</option>
                           
                        </div>
                    </div>  
        
                    <!-- Search 2 Section (Right) -->
                    <!-- <div class="serach-2">
                        <div class="serch-main" onclick="openPopup()">
                            <p><i class="fa-solid fa-chart-bar"></i></p>
                            <span>Indicator</span>
                        </div>
                        <div class="serch-dropdown" id="search2-dropdown">
                            <input type="text" placeholder="Search...">
                            <button onclick="searchFunction()">Search</button>
                        </div>
                    </div> -->
                </div>
                    <div id="tradingview-widget-container"></div> 
            </div>
        </div>

        <div id="chart-container">
            <!-- Pivotal Dashboard -->
            <div id="pivotal-dashboard">
              <h3>Pivotal Dashboard</h3>
              <table>
                <tr>
                  <th>Timeframe</th>
                  <th>Trade</th>
                  <th>Price</th>
                  <th>Date and Time</th>
                </tr>
                <tr>
                  <td>Chart</td>
                  <td>Long</td>
                  <td>5929.03</td>
                  <td>Nov 6/24 9:30 AM</td>
                </tr>
                <tr>
                  <td>Chart</td>
                  <td>Long</td>
                  <td>5917.03</td>
                  <td>Nov 6/24 9:30 AM</td>
                </tr>
                <tr>
                  <td>Chart</td>
                  <td>Long</td>
                  <td>5929.03</td>
                  <td>Nov 6/24 9:30 AM</td>
                </tr>
              </table>
            </div>
          </div>
          
        <!-- <div class="stock-info">
            <div class="top-bar bottom-bar">
              <p id="test1" class="tab-button active">Overview</p>
              <p id="test2" class="tab-button">List Of Trade</p> 
            </div>
            <div class="content-bottom">
              <div id="content1" class="content" style="display:none;">
                <div class="row-content">
                    <div class="box-content">
                        <p>Total Return <i class="fa-solid fa-circle-info"></i></p>
                        <p class="sm-text" style="color: {% if data_dict.Return < 0 %}red{% else %}#00e4a3{% endif %};">{{data_dict.Return}} %</p>
                    </div>
                    <div class="box-content">
                        <p>Total Close Trade <i class="fa-solid fa-circle-info"></i></p>
                        <p class="sm-text">{{data_dict.total_trades}}</p>
                    </div>
                    <div class="box-content">
                        <p>Best Trades <i class="fa-solid fa-circle-info"></i></p>
                        <p class="sm-text" style="color: {% if data_dict.best_trades < 0 %}red{% else %}#00e4a3{% endif %};">{{data_dict.best_trades}} %</p>
                    </div>
                    <div class="box-content">
                        <p>Buy Hold Return <i class="fa-solid fa-circle-info"></i></p>
                        <p class="sm-text" style="color: {% if data_dict.buy_hold_return < 0 %}red{% else %}#00e4a3{% endif %};">{{data_dict.buy_hold_return}} %</p>
                    </div>
                    <div class="box-content">
                        <p>Max Dropdown <i class="fa-solid fa-circle-info"></i></p>
                        <p class="sm-text" style="color: {% if data_dict.Max_dropdown < 0 %}red{% else %}#00e4a3{% endif %};">{{data_dict.Max_dropdown}} %</p>
                    </div>
                    
                    <div class="box-content">
                        <p>Win Rate <i class="fa-solid fa-circle-info"></i></p>
                        <p class="sm-text" style="color: {% if data_dict.win_rate < 0 %}red{% else %}#00e4a3{% endif %};">{{data_dict.win_rate}}%</p>
                    </div>
                    <div class="box-content">
                        <p>Max dropdown duration <i class="fa-solid fa-circle-info"></i></p>
                        <p class="sm-text">{{data_dict.max_dropdown_duration}}</p>
                    </div>
                    <div class="box-content">
                        <p>Average Dropdown duration <i class="fa-solid fa-circle-info"></i></p>
                        <p class="sm-text">{{data_dict.average_dropdown_duration}}</p>
                    </div>
                    <div class="box-content">
                        <p>Worst Trades <i class="fa-solid fa-circle-info"></i></p>
                        <p class="sm-text" style="color: {% if data_dict.worst_trades < 0 %}red{% else %}#00e4a3{% endif %};">{{data_dict.worst_trades}}</p>
                    </div>
                    <div class="box-content">
                        <p>Profit Factor <i class="fa-solid fa-circle-info"></i></p>
                        <p class="sm-text" style="color: {% if data_dict.profit_factor < 0 %}red{% else %}#00e4a3{% endif %};">{{data_dict.profit_factor}} %</p>
                    </div>
                </div>
              </div>
              <div id="content2" class="content" style="display:none;">
                <div class="table-container">
                    <table>
                      <thead>
                        <tr>
                          <th>Entry Time</th>
                          <th>Exit Time</th>
                          <th>Entry Price</th>
                          <th>Exit Price</th>
                          <th>PnL</th>
                          <th>Returns</th>
                          <th>Duration</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for data in trades_data%}
                        <tr>
                          <td>{{data.EntryTime|date:"Y-m-d H:i:s"}}</td>
                          <td>{{data.ExitTime|date:"Y-m-d H:i:s"}}</td>
                          <td>{{data.EntryPrice}}</td>
                          <td>{{data.ExitPrice}}</td>
                          <td style="color: {% if data.PnL < 0 %}red{% else %}#00e4a3{% endif %};">{{data.PnL}}</td>
                          <td style="color: {% if data.ReturnPct < 0 %}red{% else %}#00e4a3{% endif %};">{{data.ReturnPct}}</td>
                          <td>{{data.Duration}}</td>
                        </tr>
                  {% endfor %}
                      </tbody>
                    </table>
                  </div>    
              </div>

            </div>
          </div>
           -->
    </div>
  
</div>

<script>



    const profile = document.getElementById('profile');
    const dropdown = document.getElementById('dropdown');

    profile.addEventListener('click', () => {
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    });

    window.addEventListener('click', (event) => {
        if (!profile.contains(event.target)) {
            dropdown.style.display = 'none';
        }
    });
</script>


<script>

    function saveSymbolToDB(symbol) {
        console.log(symbol);
        fetch('../../admin/save-symbol/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(), 
            },
            body: JSON.stringify({ symbol: symbol })
        })
        .then(response => {
            if (response.ok) {
                location.reload(true);
                return response.json();
                

            } else {
                throw new Error('Failed to save symbol.');
            }
        })
        .then(data => {
            console.log('Symbol saved successfully:', data);
        })
        .catch(error => {
            console.error('Error saving symbol:', error);
        });
    }

</script>


<script>


function saveInterval(interval) {
    console.log(interval);
    fetch('/admin/save-interval/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken() // Add CSRF token for security
        },
        body: JSON.stringify({ interval: interval })
    })
    .then(response => {
        if (response.ok) {
            location.reload(true);
            return response.json();
        } else {
            throw new Error('Failed to save interval');
        }
    })
    .then(data => {
        console.log('Interval saved:', data);
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

</script>


<script>

    function toggleSearchDropdown(id) {
        const dropdown = document.getElementById(id);
        const isCurrentlyVisible = dropdown.style.display === 'block';
        

        closeAllDropdowns();
        
 
        if (!isCurrentlyVisible) {
            dropdown.style.display = 'block';
        }
    }

 
    function closeAllDropdowns() {
        const dropdowns = document.querySelectorAll('.serch-dropdown');
        dropdowns.forEach(dropdown => {
            dropdown.style.display = 'none';
        });
    }

    document.addEventListener('click', function(event) {
        const search1Dropdown = document.getElementById('search1-dropdown');
        const search2Dropdown = document.getElementById('search2-dropdown');
        

        if (!event.target.closest('.search1') && !event.target.closest('.serach-2')) {
            closeAllDropdowns();
        }
    });

    function searchFunction() {
        const searchQuery = event.target.previousElementSibling.value;
        alert('Searching for: ' + searchQuery);
    }

   
</script>


<script>
    // Function to toggle the timer dropdown
    function toggleTimerDropdown(event) {
        const dropdown = document.getElementById('timer-dropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        event.stopPropagation(); // Prevent the dropdown from closing when clicking inside
    }

    // Close the dropdown if clicked outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('timer-dropdown');
        const button = document.querySelector('.dropdown-btn');
        if (!event.target.closest('.timer') && !event.target.closest('.dropdown-btn')) {
            dropdown.style.display = 'none';
        }
    });

    // Function to update the timer based on selected option
    function updateTimer(selectedOption) {
        const timerDisplay = document.querySelector('.timer');
        let hour = 0;
        let minute = 0;
        let second = 0;

       
        if (selectedOption === '1d') {
            day = 1;
        }else if (selectedOption === '5d'){
            day= 5;
        }

        saveInterval(selectedOption);


        // Update the timer display
        document.querySelector('.hour').textContent = hour ? hour + 'h' : '';
        document.querySelector('.min').textContent = minute ? minute + 'm' : '';
        document.querySelector('.sec').textContent = second ? second : '';

        // Change the button text to show the selected time
        document.querySelector('.dropdown-btn').innerHTML = `${hour ? hour + ' hour' : ''} ${minute ? minute + ' minutes' : ''} <i class="fa fa-caret-down"></i>`;
    }

    // Set event listeners for the dropdown options
    const options = document.querySelectorAll('.timer-dropdown option');
    options.forEach(option => {
        option.addEventListener('click', function() {
            updateTimer(option.value);
            document.getElementById('timer-dropdown').style.display = 'none';
        });
    });
</script>

   <script>
        function openPopup() {
            document.getElementById('popup').style.display = 'block';
        }

        function filterSymbols() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const symbols = document.querySelectorAll('.symbol-item');

            symbols.forEach(symbol => {
                const symbolText = symbol.textContent.toLowerCase();
                if (symbolText.includes(input)) {
                    symbol.style.display = '';
                } else {
                    symbol.style.display = 'none';
                }
            });
        }
    </script>



<script>
    // Function to open the popup in the center of the screen
function openPopup() {
    const popup = document.getElementById('popup');
    popup.style.display = 'block';
    popup.style.position = 'fixed';
    popup.style.top = '50%';
    popup.style.left = '50%';
    popup.style.transform = 'translate(-50%, -50%)';
    popup.style.zIndex = '9999'; // Ensure it appears on top

    document.body.classList.add('blur');
}

// Function to close the popup
function closePopup() {
    const popup = document.getElementById('popup');
    popup.style.display = 'none';

    document.body.classList.remove('blur');

}

// Function to filter symbols in the popup
function filterSymbols() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    const symbols = document.querySelectorAll('.symbol-item');

    symbols.forEach(symbol => {
        const symbolText = symbol.textContent.toLowerCase();
        if (symbolText.includes(input)) {
            symbol.style.display = '';
        } else {
            symbol.style.display = 'none';
        }
    });
}
</script>

<!-- <script>
document.addEventListener("DOMContentLoaded", function () {
  document.getElementById("content1").style.display = "block";
  document.getElementById("content2").style.display = "none";
  document.getElementById("test1").classList.add("active");
});

function setActiveTab(clickedTab, contentToShow) {
  document.querySelectorAll(".tab-button").forEach(button => {
    button.classList.remove("active");
  });
  clickedTab.classList.add("active");
  document.getElementById("content1").style.display = "none";
  document.getElementById("content2").style.display = "none";
  document.getElementById(contentToShow).style.display = "block";
}
document.getElementById("test1").addEventListener("click", function () {
  setActiveTab(this, "content1");
});
document.getElementById("test2").addEventListener("click", function () {
  setActiveTab(this, "content2");
});
</script> -->
  
<script>
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("content1").style.display = "block";
      document.getElementById("content2").style.display = "none";
      document.getElementById("test1").classList.add("active");
    });
    
    function setActiveTab(clickedTab, contentToShow) {
      // Remove 'active' class and reset color for all tabs
      document.querySelectorAll(".tab-button").forEach(button => {
        button.classList.remove("active");
      });
      
      // Add 'active' class and set color for the clicked tab
      clickedTab.classList.add("active");
    
      // Hide all content and show only the selected tab's content
      document.getElementById("content1").style.display = "none";
      document.getElementById("content2").style.display = "none";
      document.getElementById(contentToShow).style.display = "block";
    }
    
    // Event listeners for tabs
    document.getElementById("test1").addEventListener("click", function () {
      setActiveTab(this, "content1");
    });
    document.getElementById("test2").addEventListener("click", function () {
      setActiveTab(this, "content2");
    });
    </script>
    

    <script>
        const char_data = {{ chart_data|safe }};
        const trade_data ={{ trades_data|safe }};
        const vol_data = {{volume_data|safe }};
        
 
        const chart = LightweightCharts.createChart(document.getElementById('tradingview-widget-container'), {
            width: 1400,
            height: 500,
            layout: {
                backgroundColor: '#1E1E1E',  
                textColor: '#FFFFFF',       
            },
            grid: {
                vertLines: { color: '#2B2B2B' }, 
                horzLines: { color: '#2B2B2B' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            priceScale: {
                borderColor: '#555', 
            },
            timeScale: {
                borderColor: '#555',
            },
        });
        const candlestickSeries = chart.addCandlestickSeries({
            upColor: '#4CAF50',       
            downColor: '#F44336',     
            borderUpColor: '#4CAF50',
            borderDownColor: '#F44336',
            wickUpColor: '#4CAF50',
            wickDownColor: '#F44336',
        });

        candlestickSeries.setData(
            char_data  
        );
        candlestickSeries.setMarkers(trade_data);


        const volumeSeries = chart.addHistogramSeries({
            color: '#26a69a',  // Default color for volume bars
            priceFormat: {
                type: 'volume',
            },
            priceScaleId: '', // Creates a separate scale for the volume
            scaleMargins: {
                top: 0.7,    // Move volume series to the bottom 30% of the chart
                bottom: 0,
            },
        });
        volumeSeries.setData(vol_data);
        // candlestickSeries.setData([
        //     { time: '2024-01-01', open: 100, high: 110, low: 95, close: 105 },
        //     { time: '2024-01-02', open: 105, high: 115, low: 100, close: 110 },
        //     { time: '2024-01-03', open: 110, high: 118, low: 108, close: 112 },
        //     { time: '2024-01-04', open: 112, high: 120, low: 110, close: 118 },
        //     { time: '2024-01-05', open: 118, high: 125, low: 115, close: 122 },
        //     { time: '2024-01-06', open: 122, high: 130, low: 120, close: 125 },
        // ]);

        // candlestickSeries.setMarkers([
        //     { time: '2024-01-03', position: 'aboveBar', color: '#FF4444', shape: 'arrowDown', text: 'S' },
        //     { time: '2024-01-06', position: 'aboveBar', color: '#FF4444', shape: 'arrowDown', text: 'CL' },
        //     { time: '2024-01-02', position: 'belowBar', color: '#4285F4', shape: 'arrowUp', text: 'L' },
        //     { time: '2024-01-04', position: 'belowBar', color: '#4285F4', shape: 'arrowUp', text: 'L' },
        //     { time: '2024-01-05', position: 'belowBar', color: '#34A853', shape: 'circle', text: 'L' },
        //     { time: '2024-01-03', position: 'aboveBar', color: '#FF4444', shape: 'circle', text: 'CL' },
        // ]);
        chart.timeScale().fitContent();
    </script>
<script>
function openPopup() {
    document.getElementById('popup').style.display = 'block';
}

function closePopup() {
    document.getElementById('popup').style.display = 'none';
}

function filterSymbols() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    const symbols = document.querySelectorAll('.symbol-item');

    symbols.forEach(symbol => {
        const text = symbol.textContent.toLowerCase();
        symbol.style.display = text.includes(input) ? 'block' : 'none';
    });
}

function selectSymbol(symbolText) {
    const activeSearchMain = document.querySelector('.serch-main.active');
    if (activeSearchMain) {
        const spanElement = activeSearchMain.querySelector('span');
        if (spanElement) {
            spanElement.textContent = symbolText;
        }
    }

    closePopup();
}

const symbolItems = document.querySelectorAll('.symbol-item');
symbolItems.forEach(item => {
    item.addEventListener('click', function () {
        const symbolText = this.textContent.split(' - ')[0]; // Get the symbol code (e.g., MSFT)
        selectSymbol(symbolText);
    });
});

const searchMainDivs = document.querySelectorAll('.serch-main');
searchMainDivs.forEach(div => {
    div.addEventListener('click', function () {
        searchMainDivs.forEach(d => d.classList.remove('active'));
        this.classList.add('active');
        openPopup();
    });
});



function getCSRFToken() {
        const cookieValue = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
        return cookieValue ? cookieValue.split('=')[1] : '';
}

</script>


{% endblock %}